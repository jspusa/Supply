<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>訂單分析器</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif; color: #0f1d2b; }
    body { margin: 0; padding: 32px 18px 48px; background: radial-gradient(circle at 10% 20%, #f3f6ff 0, #f7f9fc 30%, #f9fbff 60%, #fff 100%); }
    .page { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 22px; margin: 0 0 16px; color: #0b1624; letter-spacing: 0.4px; }
    h2 { font-size: 15px; margin: 0 0 6px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 10px 0; }
    textarea { width: 100%; min-height: 120px; padding: 12px; font-size: 13px; line-height: 1.4; border-radius: 10px; border: 1px solid #d7deea; background: #fff; box-shadow: inset 0 1px 2px rgba(15, 29, 43, 0.03); }
    button { padding: 10px 14px; cursor: pointer; border-radius: 10px; border: 1px solid #d1d9e5; background: #0b6bcb; color: #fff; font-weight: 600; box-shadow: 0 3px 10px rgba(11, 107, 203, 0.15); transition: transform 0.05s ease, box-shadow 0.15s ease; }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(11, 107, 203, 0.25); }
    button.secondary { background: #fff; color: #0f1d2b; border-color: #d1d9e5; box-shadow: none; }
    button.secondary.active { background: #0b6bcb; color: #fff; border-color: #0b6bcb; box-shadow: 0 3px 10px rgba(11, 107, 203, 0.18); }
    label, select, input { font-size: 12px; }
    select, input[type="number"] { padding: 8px 10px; border-radius: 8px; border: 1px solid #d1d9e5; background: #fff; }
    .hint { color: #4a5565; font-size: 12px; line-height: 1.5; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    .card { border: 1px solid #dfe6f0; border-radius: 14px; padding: 0; background: #fff; box-shadow: 0 10px 35px rgba(17, 24, 39, 0.06); overflow: hidden; }
    .card summary { padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; list-style: none; cursor: pointer; user-select: none; }
    .card summary::-webkit-details-marker { display: none; }
    .card[open] summary { border-bottom: 1px solid #eef2f7; background: linear-gradient(90deg, #f7f9ff, #f0f4ff); }
    .card:not([open]) summary { background: #f9fbff; }
    .cardContent { padding: 16px; }
    .subGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .subCard { border: 1px dashed #d9e1ee; border-radius: 10px; padding: 0; overflow: hidden; background: #fdfefe; }
    .subCard summary { padding: 12px 14px; list-style: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: 8px; font-weight: 700; color: #0f1d2b; }
    .subCard summary::-webkit-details-marker { display: none; }
    .subCard[open] summary { background: #f4f7fd; border-bottom: 1px solid #e6ecf7; }
    .subCardContent { padding: 12px 14px 14px; }
    .eyebrow { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #71829e; margin: 0; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid #d1d9e5; border-radius:999px; font-size:12px; color:#0f1d2b; background: #f6f9ff; }
    .tableWrap { max-height: 520px; overflow: auto; border: 1px solid #eef2f7; border-radius: 10px; background: #fbfcff; box-shadow: inset 0 1px 2px rgba(0,0,0,0.03); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #e5ecf5; padding: 8px; font-size: 13px; }
    th { background: #f4f7fd; text-align: left; position: sticky; top: 0; color: #0f1d2b; }
    .bad { background: #fff4f4; }
    .ok  { background: #f1fbf5; }
    .warn { background: #fff8eb; }
    .count { font-weight: 600; }
    .footer { margin-top: 12px; font-size: 12px; color: #55657b; text-align: right; }
    code { background: #f4f4f4; padding: 1px 4px; border-radius: 4px; }
    .priority { border: 1px solid #c7d7f8; box-shadow: 0 10px 35px rgba(11, 107, 203, 0.08); }
  </style>
</head>
<body>
  <div class="page">
    <h1>訂單分析器</h1>

    <div class="row">
      <button id="btnBuild">整理表格</button>
      <button class="secondary" id="btnClear">清空</button>

      <label>下單門檻（天）：</label>
      <input id="daysThreshold" type="number" min="1" step="1" value="180" />
    </div>

    <div class="row">
      <label>工廠篩選：</label>
      <select id="factoryFilter">
        <option value="all">顯示全部</option>
        <option value="hideTW">隱藏台灣廠（E 開頭）</option>
        <option value="onlyTW">只看台灣廠（E 開頭）</option>
      </select>
    </div>

    <div class="row">
      <label>品項篩選：</label>
      <select id="itemFilter">
        <option value="all">顯示全部</option>
        <option value="onlyNonTurkey">非火雞筋品項</option>
        <option value="onlyTurkey">只看火雞筋</option>
      </select>
    </div>

    <div class="grid">
      <details class="card" open>
        <summary>
          <div>
            <p class="eyebrow">資料輸入區</p>
            <h2>貼上來源資料</h2>
            <div class="hint">直接貼 raw 文字即可，系統會自動解析 SKU / ASIN / 數量。</div>
          </div>
          <span class="pill">可收合</span>
        </summary>
        <div class="cardContent">
          <div class="subGrid">
            <details class="subCard" open>
              <summary>Helium 10 原始文字</summary>
              <div class="subCardContent">
                <div class="hint">抓取 <code>ASIN(10碼)</code> + 後面的 <code>SKU</code>，再取第一個數字作為速度。</div>
                <textarea id="inputH10" placeholder="貼 Helium 10 內容..."></textarea>
              </div>
            </details>
            <details class="subCard" open>
              <summary>訂單清單</summary>
              <div class="subCardContent">
                <div class="hint">Tab/空白皆可。每行第 1 欄是 SKU；數量只從「SKU 後面欄位」抓數字。重複 SKU 會加總。</div>
                <textarea id="inputOrders" placeholder="例如：
AFA11AM	5040
AFA12AM	27360
TTS05AM-1	170100
..."></textarea>
              </div>
            </details>
            <details class="subCard" open>
              <summary>美國總數</summary>
              <div class="subCardContent">
                <div class="hint">Tab/空白皆可。每行第 1 欄是 SKU；數量只從「SKU 後面欄位」抓數字。重複 SKU 會加總。</div>
                <textarea id="inputUS" placeholder="例如：
TTS05AM-1 57223
TTR01AM-4 14125
..."></textarea>
              </div>
            </details>
          </div>
        </div>
      </details>

      <!-- 180天內清單 -->
      <details class="card priority" open>
        <summary>
          <div>
            <p class="eyebrow">重點檢視 ①</p>
            <h2>門檻內可售品項：建議下單清單</h2>
            <div class="hint">只抓「可銷售天數 &lt;= 門檻」且速度 &gt; 0 的 SKU</div>
          </div>
          <div class="hint">
            筆數：<span class="count" id="countReorder">0</span>
          </div>
        </summary>

        <div class="cardContent">
          <div class="row">
            <button class="secondary" id="btnDownloadReorderCSV">下載下單清單 CSV</button>
          </div>

          <div class="tableWrap" id="reorderTableWrap"></div>
        </div>
      </details>

      <!-- 主表 -->
      <details class="card priority" open>
        <summary>
          <div>
            <p class="eyebrow">重點檢視 ②</p>
            <h2>主表（H10 產品）</h2>
            <div class="hint">SKU / 速度 / 訂單 / 美國總數 / 可銷售天數</div>
          </div>
          <div class="hint" style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            <div>筆數：<span class="count" id="countMain">0</span></div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
              <span class="pill" id="sumOrdersMain">訂單總和：0</span>
              <span class="pill" id="sumUsMain">美國總數總和：0</span>
            </div>
          </div>
        </summary>

        <div class="cardContent">
          <div class="row">
            <button class="secondary" id="btnDownloadMainCSV">下載主表 CSV</button>
            <div class="row" style="margin:0;">
              <span class="hint">主表排序：</span>
              <button class="secondary" id="btnSortSpeed">速度由大到小</button>
              <button class="secondary" id="btnSortDays">可銷售天數由小到大</button>
            </div>
          </div>

          <div class="tableWrap" id="mainTableWrap"></div>
        </div>
      </details>

      <!-- 新品（訂單有但H10沒有） -->
      <details class="card priority" open>
        <summary>
          <div>
            <p class="eyebrow">重點檢視 ③</p>
            <h2>新品（訂單有，但 H10 沒有）</h2>
            <div class="hint">SKU / 訂單 / 美國總數(若有)</div>
          </div>
          <div class="hint">
            筆數：<span class="count" id="countNewOrder">0</span>
          </div>
        </summary>

        <div class="cardContent">
          <div class="row">
            <button class="secondary" id="btnDownloadNewOrderCSV">下載新品(訂單) CSV</button>
          </div>

          <div class="tableWrap" id="newOrderWrap"></div>
        </div>
      </details>

      <!-- 新品（美國總數有但H10沒有且訂單也沒有） 預設收折 -->
      <details class="card" id="newUSDetails">
        <summary>
          <div>
            <p class="eyebrow">其他</p>
            <h2 style="margin:0;">美國總數有，但 H10 沒有，且訂單也沒有</h2>
          </div>
          <span class="hint">（預設收折，點此展開）</span>
        </summary>

        <div class="cardContent">
          <div class="row" style="justify-content: space-between;">
            <div class="hint">SKU / 美國總數</div>
            <div class="hint">
              筆數：<span class="count" id="countNewUS">0</span>
            </div>
          </div>

          <div class="row">
            <button class="secondary" id="btnDownloadNewUSCSV">下載新品(美國總數) CSV</button>
          </div>

          <div class="tableWrap" id="newUSWrap"></div>
        </div>
      </details>
    </div>

    <details class="card" id="advancedSettings">
      <summary>
        <div>
          <p class="eyebrow">設定</p>
          <h2>進階設定（可展開）</h2>
        </div>
        <span class="pill">可收合</span>
      </summary>
      <div class="cardContent">
        <div class="row">
          <label style="display:flex; gap:6px; align-items:center;">
            <input type="checkbox" id="chkDedupe" checked />
            H10 去重（以 ASIN+SKU）
          </label>
          <label style="display:flex; gap:6px; align-items:center;">
            <input type="checkbox" id="chkMissingOrderAsZero" checked />
            H10 找不到訂單時填 0
          </label>
          <label style="display:flex; gap:6px; align-items:center;">
            <input type="checkbox" id="chkMissingUsAsBlank" />
            H10 找不到美國總數時留空（不勾選則填 0）
          </label>
          <label style="display:flex; gap:6px; align-items:center;">
            <input type="checkbox" id="chkNormalizeSku" checked />
            SKU 正規化（去空白、轉大寫）
          </label>
        </div>
      </div>
    </details>

    <div class="footer">
      註：速度為 0 或抓不到速度 → 不計算可銷售天數，且不會進入「下單清單」。
    </div>
  </div>

<script>
(() => {
  const h10El = document.getElementById('inputH10');
  const ordersEl = document.getElementById('inputOrders');
  const usEl = document.getElementById('inputUS');

  const chkDedupe = document.getElementById('chkDedupe');
  const chkMissingOrderAsZero = document.getElementById('chkMissingOrderAsZero');
  const chkMissingUsAsBlank = document.getElementById('chkMissingUsAsBlank');
  const chkNormalizeSku = document.getElementById('chkNormalizeSku');

  const daysThresholdEl = document.getElementById('daysThreshold');
  const factoryFilterEl = document.getElementById('factoryFilter');
  const itemFilterEl = document.getElementById('itemFilter');
  const btnSortSpeed = document.getElementById('btnSortSpeed');
  const btnSortDays = document.getElementById('btnSortDays');

  const mainWrap = document.getElementById('mainTableWrap');
  const reorderWrap = document.getElementById('reorderTableWrap');
  const newOrderWrap = document.getElementById('newOrderWrap');
  const newUSWrap = document.getElementById('newUSWrap');

  const countMainEl = document.getElementById('countMain');
  const countReorderEl = document.getElementById('countReorder');
  const countNewOrderEl = document.getElementById('countNewOrder');
  const countNewUSEl = document.getElementById('countNewUS');

  const sumOrdersMainEl = document.getElementById('sumOrdersMain');
  const sumUsMainEl = document.getElementById('sumUsMain');

  const newUSDetails = document.getElementById('newUSDetails');

  // 工廠篩選狀態：all | hideTW | onlyTW
  let factoryMode = "all";
  let itemFilterMode = "all";
  let sortMode = "normal";

  const nonTurkeySkuSet = new Set(`
    AFA13AM AFA14AM
    AFA21AM AFA22AM AFA25AM AFA135AM
    GTS01 GTR01 GTB01 GTP01 GTZ01 GTA01 GTC01
    GTB03 GTR03 GTP03 GTS03 GTZ03
    GTB05 GTP05 GTB07
    GSF01 GSF02
    GTSL01 GTRL01 GTPL01 GTBL01 GTAL01 GTCL01
    GTRL03 GTPL03 GTBL03 GTZL03
    GTPL05 GTBL05
    GSFL01 GSFL02
    ATS01 ATB01 ATR01AM ATP01 ATZ01
    ATR01
    ATB03 ATR03 ATP03 ATZ03
    ATB05 ATP05 ATA01 ATAL01
    KTB01AM TRP01AM TTR01AM TPZ01AM
    KTB03AM TRP03AM TTR03AM TPZ03AM
    TRP05AM KTB05AM TTR05AM TPZ05AM TTS05AM
    KTB06AM
    KTB01AM-4 TTR01AM-4 TRP01AM-4 TPZ01AM-4
    KTB03AM-2 TRP03AM-2 TTR03AM-2 TPZ03AM-2
    KTB05AM-1 TRP05AM-1 TTR05AM-1 TPZ05AM-1 TTS05AM-1
    KTB06AM-4
    KTBL01 TTRL01 TPZL01 TRPL01
    KTBL03 TTRL03 TPZL03 TRPL03
    TTRL05 TRPL05 TPZL05 KTBL05 TTSL05
    AFML01 AFML03 AFML05
    GTT01 GTT03
    VTS01-1 VTB01-4 VTR01-4 VTB05-1 VTB06-4
    HDR01AM HDP01AM HDS03AM
  `.trim().split(/\s+/).filter(Boolean).map(s => s.trim().toUpperCase()));

  /** @type {{sku:string, asin:string, speed:(number|null), order:(number|null), us:(number|null), avail:(number|null), days:(number|null)}[]} */
  let mainRowsAll = [];
  /** @type {{sku:string, asin:string, speed:number, order:number, us:number, avail:number, days:number}[]} */
  let reorderRowsAll = [];
  /** @type {{sku:string, order:number, us:(number|null)}[]} */
  let newOrderRowsAll = [];
  /** @type {{sku:string, us:number}[]} */
  let newUSRowsAll = [];

  function escapeHtml(s) {
    return (s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function normalizeNumber(s) {
    if (s === null || s === undefined) return null;
    const cleaned = String(s).replace(/,/g, '');
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : null;
  }
  function normalizeSku(sku) {
    if (!chkNormalizeSku.checked) return String(sku ?? "");
    return String(sku ?? "").trim().toUpperCase();
  }
  function normalizeSkuValue(sku) {
    return String(sku ?? "").trim().toUpperCase();
  }
  function fmtDays(n) {
    if (n === null || n === undefined) return "";
    return (Math.round(n * 10) / 10).toFixed(1);
  }
  function isTaiwanFactorySKU(sku) {
    const s = String(sku ?? "");
    return s.length > 0 && s[0].toUpperCase() === "E";
  }

  function applyFactoryFilter(list) {
    if (factoryMode === "all") return list;
    if (factoryMode === "hideTW") return list.filter(r => !isTaiwanFactorySKU(r.sku));
    if (factoryMode === "onlyTW") return list.filter(r => isTaiwanFactorySKU(r.sku));
    return list;
  }

  function applyFilters(list) {
    let rows = applyFactoryFilter(list);
    if (itemFilterMode === "onlyNonTurkey") {
      return rows.filter(r => nonTurkeySkuSet.has(normalizeSkuValue(r.sku)));
    }
    if (itemFilterMode === "onlyTurkey") {
      return rows.filter(r => !nonTurkeySkuSet.has(normalizeSkuValue(r.sku)));
    }
    return rows;
  }

  function parseH10ToRows(raw) {
    const re = /([A-Z0-9]{10})([A-Z0-9][A-Z0-9-]{1,})/g;
    const found = [];
    let m;
    while ((m = re.exec(raw)) !== null) {
      const asin = m[1];
      const sku  = normalizeSku(m[2]);

      const lookahead = raw.slice(re.lastIndex, re.lastIndex + 400);
      const numMatch = lookahead.match(/(\d+(?:,\d{3})*(?:\.\d+)?)/);
      const speed = numMatch ? normalizeNumber(numMatch[1]) : null;

      found.push({ sku, asin, speed, order: null, us: null, avail: null, days: null });
    }
    return found;
  }

  function dedupeH10(list) {
    const seen = new Set();
    const out = [];
    for (const r of list) {
      const key = `${r.asin}__${r.sku}`;
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(r);
    }
    return out;
  }

  function parseSkuNumberMap(raw) {
    const map = new Map();
    const lines = (raw || "").split(/\r?\n/);

    for (let line of lines) {
      line = line.trim();
      if (!line) continue;

      const lower = line.toLowerCase();
      if (lower.includes("productcode") || lower.includes("品號") ||
          lower.includes("裝櫃日") || lower.includes("預計到港日") ||
          lower.includes("美國總數") || (lower.includes("sku") && lower.includes("總數"))) continue;

      let cols = line.split(/\t+/).map(s => s.trim()).filter(Boolean);
      if (cols.length < 2) cols = line.split(/\s+/).map(s => s.trim()).filter(Boolean);
      if (cols.length < 2) continue;

      const sku = normalizeSku(cols[0]);
      if (!/^[A-Z0-9][A-Z0-9-]{2,}$/i.test(sku)) continue;

      const tail = cols.slice(1).join(" ");
      const nums = tail.match(/-?\d+(?:,\d{3})*(?:\.\d+)?/g);
      if (!nums || nums.length === 0) continue;

      const val = normalizeNumber(nums[nums.length - 1]);
      if (val === null) continue;

      map.set(sku, (map.get(sku) ?? 0) + val);
    }
    return map;
  }

  function computeDerived(r) {
    const order = (r.order ?? 0);
    const us = (r.us ?? 0);
    r.avail = order + us;

    if (r.speed === null || r.speed <= 0) {
      r.days = null;
      return;
    }
    r.days = r.avail / r.speed;
  }

  function sortMain(rows) {
    if (sortMode === "days_asc") {
      rows.sort((a,b) => {
        const ad = (a.days === null ? Infinity : a.days);
        const bd = (b.days === null ? Infinity : b.days);
        if (ad !== bd) return ad - bd;
        const as = (a.speed === null ? -Infinity : a.speed);
        const bs = (b.speed === null ? -Infinity : b.speed);
        return bs - as;
      });
      return;
    }
    rows.sort((a,b) => {
      const as = (a.speed === null ? -Infinity : a.speed);
      const bs = (b.speed === null ? -Infinity : b.speed);
      return bs - as;
    });
  }

  function buildTables() {
    const rawH10 = h10El.value || "";
    const rawOrders = ordersEl.value || "";
    const rawUS = usEl.value || "";

    let h10Rows = parseH10ToRows(rawH10);
    if (chkDedupe.checked) h10Rows = dedupeH10(h10Rows);

    const orderMap = parseSkuNumberMap(rawOrders);
    const usMap = parseSkuNumberMap(rawUS);

    const h10SkuSet = new Set(h10Rows.map(r => r.sku));

    for (const r of h10Rows) {
      const o = orderMap.get(r.sku);
      const u = usMap.get(r.sku);

      r.order = (o === undefined) ? (chkMissingOrderAsZero.checked ? 0 : null) : o;
      if (u === undefined) r.us = chkMissingUsAsBlank.checked ? null : 0;
      else r.us = u;

      computeDerived(r);
    }

    const newOrder = [];
    for (const [sku, qty] of orderMap.entries()) {
      if (!h10SkuSet.has(sku)) {
        const u = usMap.get(sku);
        newOrder.push({ sku, order: qty, us: (u === undefined ? null : u) });
      }
    }

    const newUS = [];
    for (const [sku, u] of usMap.entries()) {
      if (!h10SkuSet.has(sku) && !orderMap.has(sku)) {
        newUS.push({ sku, us: u });
      }
    }

    const threshold = Math.max(1, Number(daysThresholdEl.value || 180));
    const reorder = h10Rows
      .filter(r => r.days !== null && r.days <= threshold && r.speed !== null && r.speed > 0)
      .map(r => ({
        sku: r.sku,
        asin: r.asin,
        speed: r.speed,
        order: (r.order ?? 0),
        us: (r.us ?? 0),
        avail: (r.avail ?? 0),
        days: (r.days ?? 0)
      }));

    sortMain(h10Rows);
    reorder.sort((a,b) => a.days - b.days);
    newOrder.sort((a,b) => b.order - a.order);
    newUS.sort((a,b) => b.us - a.us);

    mainRowsAll = h10Rows;
    reorderRowsAll = reorder;
    newOrderRowsAll = newOrder;
    newUSRowsAll = newUS;

    renderAll();
  }

  function sum(list, key) {
    return list.reduce((acc, r) => acc + (Number(r[key] ?? 0) || 0), 0);
  }

  function renderAll() {
    renderReorder();
    renderMain();
    renderNewOrder();
    renderNewUS();
  }

  function renderReorder() {
    const rows = applyFilters(reorderRowsAll);
    countReorderEl.textContent = String(rows.length);

    if (rows.length === 0) { reorderWrap.innerHTML = ""; return; }

    const body = rows.map((r, idx) => `
      <tr>
        <td>${idx + 1}</td>
        <td>${escapeHtml(r.sku)}</td>
        <td class="ok">${escapeHtml(String(r.speed))}</td>
        <td class="ok">${escapeHtml(String(r.order))}</td>
        <td class="ok">${escapeHtml(String(r.us))}</td>
        <td class="warn">${escapeHtml(fmtDays(r.days))}</td>
      </tr>
    `).join("");

    reorderWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>#</th><th>SKU</th><th>速度</th><th>訂單</th><th>美國總數</th><th>可銷售天數</th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    `;
  }

  function renderMain() {
    const rows = applyFilters(mainRowsAll);
    countMainEl.textContent = String(rows.length);
    sumOrdersMainEl.textContent = `訂單總和：${sum(rows, "order")}`;
    sumUsMainEl.textContent = `美國總數總和：${sum(rows, "us")}`;

    if (rows.length === 0) { mainWrap.innerHTML = ""; return; }

    const body = rows.map((r, idx) => {
      const speedCell = (r.speed === null) ? `<td class="bad">(未抓到)</td>` : `<td class="ok">${escapeHtml(String(r.speed))}</td>`;
      const orderCell = (r.order === null) ? `<td class="bad">(未對應)</td>` : `<td class="ok">${escapeHtml(String(r.order))}</td>`;
      const usCell = (r.us === null) ? `<td class="bad">(未對應)</td>` : `<td class="ok">${escapeHtml(String(r.us))}</td>`;
      const daysCell = (r.days === null) ? `<td class="bad">(不可算)</td>` : `<td class="ok">${escapeHtml(fmtDays(r.days))}</td>`;

      return `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.sku)}</td>
          ${speedCell}
          ${orderCell}
          ${usCell}
          ${daysCell}
        </tr>
      `;
    }).join("");

    mainWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>#</th><th>SKU</th><th>速度</th><th>訂單</th><th>美國總數</th><th>可銷售天數</th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    `;
  }

  function renderNewOrder() {
    const rows = applyFilters(newOrderRowsAll);
    countNewOrderEl.textContent = String(rows.length);
    if (rows.length === 0) { newOrderWrap.innerHTML = ""; return; }

    const body = rows.map((r, idx) => {
      const usCell = (r.us === null) ? `<td class="bad">(未提供)</td>` : `<td class="ok">${escapeHtml(String(r.us))}</td>`;
      return `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.sku)}</td>
          <td class="ok">${escapeHtml(String(r.order))}</td>
          ${usCell}
        </tr>
      `;
    }).join("");

    newOrderWrap.innerHTML = `
      <table>
        <thead>
          <tr><th>#</th><th>SKU</th><th>訂單</th><th>美國總數</th></tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    `;
  }

  function renderNewUS() {
    const rows = applyFilters(newUSRowsAll);
    // countNewUS 只有在展開時才顯示也可以，但這裡保留更新
    countNewUSEl.textContent = String(rows.length);
    if (rows.length === 0) { newUSWrap.innerHTML = ""; return; }

    const body = rows.map((r, idx) => `
      <tr>
        <td>${idx + 1}</td>
        <td>${escapeHtml(r.sku)}</td>
        <td class="ok">${escapeHtml(String(r.us))}</td>
      </tr>
    `).join("");

    newUSWrap.innerHTML = `
      <table>
        <thead>
          <tr><th>#</th><th>SKU</th><th>美國總數</th></tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    `;
  }

  // ---- Export ----
  function download(filename, content, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function csvFromRows(headers, rows) {
    const q = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
    const head = headers.map(q).join(",");
    const body = rows.map(r => r.map(q).join(",")).join("\n");
    return head + "\n" + body;
  }

  function exportMainRowsFiltered() {
    const rows = applyFilters(mainRowsAll);
    const headers = ["SKU","ASIN","速度","訂單","美國總數","可售總量(美國+訂單)","可銷售天數"];
    const body = rows.map(r => [
      r.sku, r.asin,
      (r.speed ?? ""),
      (r.order ?? ""),
      (r.us ?? ""),
      (r.avail ?? ""),
      (r.days === null ? "" : fmtDays(r.days))
    ]);
    return { headers, body };
  }
  function exportReorderRowsFiltered() {
    const rows = applyFilters(reorderRowsAll);
    const headers = ["SKU","ASIN","速度","訂單","美國總數","可售總量(美國+訂單)","可銷售天數"];
    const body = rows.map(r => [
      r.sku, r.asin, String(r.speed), String(r.order), String(r.us), String(r.avail), fmtDays(r.days)
    ]);
    return { headers, body };
  }
  function exportNewOrderRowsFiltered() {
    const rows = applyFilters(newOrderRowsAll);
    const headers = ["SKU","訂單","美國總數"];
    const body = rows.map(r => [r.sku, String(r.order), (r.us ?? "").toString()]);
    return { headers, body };
  }
  function exportNewUSRowsFiltered() {
    const rows = applyFilters(newUSRowsAll);
    const headers = ["SKU","美國總數"];
    const body = rows.map(r => [r.sku, String(r.us)]);
    return { headers, body };
  }

  // ---- UI wiring ----
  document.getElementById("btnBuild").addEventListener("click", buildTables);

  document.getElementById("btnClear").addEventListener("click", () => {
    h10El.value = ""; ordersEl.value = ""; usEl.value = "";
    mainRowsAll = []; reorderRowsAll = []; newOrderRowsAll = []; newUSRowsAll = [];
    mainWrap.innerHTML = ""; reorderWrap.innerHTML = ""; newOrderWrap.innerHTML = ""; newUSWrap.innerHTML = "";
    countMainEl.textContent = "0"; countReorderEl.textContent = "0"; countNewOrderEl.textContent = "0"; countNewUSEl.textContent = "0";
    sumOrdersMainEl.textContent = "訂單總和：0"; sumUsMainEl.textContent = "美國總數總和：0";
    factoryMode = "all";
    itemFilterMode = "all";
    sortMode = "normal";
    factoryFilterEl.value = "all";
    itemFilterEl.value = "all";
    updateSortButtons();
    // ⑦維持收折（預設）
    newUSDetails.open = false;
  });

  daysThresholdEl.addEventListener("change", () => buildTables());

  factoryFilterEl.addEventListener("change", (event) => {
    factoryMode = event.target.value;
    renderAll();
  });

  itemFilterEl.addEventListener("change", (event) => {
    itemFilterMode = event.target.value;
    renderAll();
  });

  function updateSortButtons() {
    btnSortSpeed.classList.toggle("active", sortMode === "normal");
    btnSortDays.classList.toggle("active", sortMode === "days_asc");
  }

  btnSortSpeed.addEventListener("click", () => {
    sortMode = "normal";
    updateSortButtons();
    buildTables();
  });

  btnSortDays.addEventListener("click", () => {
    sortMode = "days_asc";
    updateSortButtons();
    buildTables();
  });

  // Export buttons
  document.getElementById("btnDownloadMainCSV").addEventListener("click", () => {
    const ex = exportMainRowsFiltered();
    download("主表.csv", "\uFEFF" + csvFromRows(ex.headers, ex.body), "text/csv;charset=utf-8");
  });

  document.getElementById("btnDownloadReorderCSV").addEventListener("click", () => {
    const ex = exportReorderRowsFiltered();
    download("下單清單.csv", "\uFEFF" + csvFromRows(ex.headers, ex.body), "text/csv;charset=utf-8");
  });

  document.getElementById("btnDownloadNewOrderCSV").addEventListener("click", () => {
    const ex = exportNewOrderRowsFiltered();
    download("新品_訂單.csv", "\uFEFF" + csvFromRows(ex.headers, ex.body), "text/csv;charset=utf-8");
  });

  document.getElementById("btnDownloadNewUSCSV").addEventListener("click", () => {
    const ex = exportNewUSRowsFiltered();
    download("新品_美國總數.csv", "\uFEFF" + csvFromRows(ex.headers, ex.body), "text/csv;charset=utf-8");
  });

  // ⑦ 預設收折
  newUSDetails.open = false;
  updateSortButtons();
})();
</script>
</body>
</html>
